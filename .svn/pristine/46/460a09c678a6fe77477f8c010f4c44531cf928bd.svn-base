package com.yqjr.fin.mkmm.sales.services;

import com.yqjr.fin.mkmm.sales.condition.MaterialBaseCondition;
import com.yqjr.fin.mkmm.sales.entity.MaterialBaseHis;
import com.yqjr.fin.mkmm.sales.rest.vo.SelectCodeVo;
import com.yqjr.scfw.common.Const;
import com.yqjr.scfw.common.exception.ValidationException;
import com.yqjr.scfw.common.service.BaseService;
import com.yqjr.fin.mkmm.sales.entity.MaterialBase;
import com.yqjr.fin.mkmm.sales.mapper.MaterialBaseMapper;
import com.yqjr.scfw.common.session.SessionHolder;
import com.yqjr.scfw.common.session.UserContext;
import com.yqjr.scfw.common.utils.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;

@Service
@Transactional(readOnly = true)
public class MaterialBaseService extends BaseService<MaterialBaseMapper, MaterialBase, Long> {

    //region generated by CodeRobot
    @Autowired
    MaterialBaseHisService materialBaseHisService;
    @Autowired
    MaterialBaseMapper materialBaseMapper;

    /**
     * 查询该素材名称是否存在
     * @param materialBase
     * @return
     */
    public MaterialBase selectByMaterialName(MaterialBase materialBase){
        return materialBaseMapper.selectByMaterialName(materialBase);
    }

    @Transactional(rollbackFor = { Exception.class })
    public void insertToHis(MaterialBase condition){
        MaterialBaseHis materialBaseHis = new MaterialBaseHis();
        BeanUtils.copyProperties(materialBaseHis,condition);
        materialBaseHisService.insert(materialBaseHis);
    }

    /**
     * 查询所有素材
     * @return
     */
    public List<SelectCodeVo> selectMaterialBaseAll() {
        UserContext userContext = SessionHolder.getUserContext();
        MaterialBaseCondition materialBaseCondition = new MaterialBaseCondition();
        materialBaseCondition.setAreaCode(userContext.getAreaCode());
        materialBaseCondition.setCompany(userContext.getComCode());
        List<MaterialBase> materialBases = this.selectList(materialBaseCondition);

        List<SelectCodeVo> selectCodeVos = new ArrayList<>();
        SelectCodeVo selectCodeVo = new SelectCodeVo();

        for(MaterialBase materialBase : materialBases) {
            selectCodeVo.setHeadLetter("");
            selectCodeVo.setLabel(materialBase.getMaterialName());
            selectCodeVo.setValue(materialBase.getMaterialCode());
            selectCodeVos.add(selectCodeVo);
        }
        return selectCodeVos;
    }

    /**
     * 素材新增
     */
    @Transactional(rollbackFor = {Exception.class})
    public void insertMsg(MaterialBase condition){
        MaterialBase materialBase = new MaterialBase();
        materialBase.setMaterialName(condition.getMaterialName());
        UserContext userContext = SessionHolder.getUserContext();
        materialBase.setAreaCode(userContext.getAreaCode());
        materialBase.setAreaName(userContext.getAreaName());
        materialBase.setCompany(userContext.getComCode());
        MaterialBase materialBase1 = this.selectByMaterialName(materialBase);
        if(materialBase1 != null){
            throw new ValidationException("该素材名称已经被占用");
        }
        this.insert(condition);
    }
}